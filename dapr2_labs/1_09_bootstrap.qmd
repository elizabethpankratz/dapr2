---
title: "Bootstraping"
link-citations: TRUE
params: 
    SHOW_SOLS: TRUE
    TOGGLE: TRUE
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
source('assets/setup.R')
set.seed(3)
```

:::lo

### <i class="fa fa-graduation-cap"></i> Learning Objectives
At the end of this lab, you will:

1. Understand the principles of bootstrapping
2. Apply the bootstrap confidence interval to inference in linear models

### <i class="fa fa-check-square-o fa-2"></i> What You Need

1. Be up to date with lectures
2. Have completed previous lab exercises from [Week X]() and [Week X]()

### <i class="fab fa-r-project"></i> Required R Packages
Remember to load all packages within a code chunk at the start of your RMarkdown file using `library()`. If you do not have a package and need to install, do so within the console using `install.packages(" ")`. For further guidance on installing/updating packages, see Section C [here](https://uoepsy.github.io/files/install-update-r#update-pkgs). 

For this lab, you will need to load the following package(s):

* **tidyverse** 
* **psych**
* **patchwork**
* **sjPlot**
* **kableExtra**
* **car**

### <i class="fa fa-pencil-square-o" aria-hidden="true"></i> Presenting Results
All results should be presented following [APA guidelines](https://apastyle.apa.org/instructional-aids/numbers-statistics-guide.pdf). If you need a reminder on how to hide code, format tables/plots, etc., make sure to review the [rmd bootcamp](https://uoepsy.github.io//rmd-bootcamp/).

The example write-up sections included as part of the solutions are **not perfect** - they instead should give you a good example of what information you should include and how to structure this. Note that you must **not** copy any of the write-ups included below for future reports - if you do, you will be committing plagiarism, and this type of academic misconduct is taken very seriously by the University. You can find out more [here](https://www.ed.ac.uk/academic-services/students/conduct/academic-misconduct).

### <i class="fa fa-file"></i> Lab Data
You can download the data required for this lab [here](https://uoepsy.github.io/data/science-faith-attitude.csv) or read it in via this link https://uoepsy.github.io/data/science-faith-attitude.csv. 

:::


# Study Overview

> **Research Question**
>
> Is age and knowledge about science associated with attitudes towards science and faith?

`r optbegin("Recall Codebook", olabel=FALSE, toggle=params$TOGGLE)` 

__Description__

This week's lab explores whether knowledge about science and age are associated with attitudes towards science and faith. To examine these associations, we will use a subset of data from the 2005 Eurobarometer 63.1 survey. 

__Data Dictionary__

```{r echo=FALSE, message=FALSE, warning=FALSE}
ebsurvey <- read_csv("https://uoepsy.github.io/data/science-faith-attitude.csv")
tibble(
variable = names(ebsurvey),
description = c("Participant ID", "Nation ID:  1 = France, 2 = Belgium, 3 = The Netherlands, 4 = Germany West, 5 = Italy, 6 = Luxembourg, 7 = Denmark, 8 = Ireland, 9 = Great Britain, 10 = Northern Ireland, 11 = Greece, 12 = Spain, 13 = Portugal, 14 = Germany East, 15 = Norway, 16 = Finland, 17 = Sweden, 18 = Austria, 19 = Cyprus (Republic), 20 = Czech Republic, 21 = Estonia, 22 = Hungary, 23 = Latvia, 24 = Lithuania, 25 = Malta, 26 = Poland, 27 = Slovakia, 28 = Slovenia, 29 = Bulgaria, 30 = Romania, 31 = Turkey, 32 = Croatia, 33 Cyprus (TCC; not included), 34 = Iceland, 35 = Switzerland", "Score on a science quiz composed of 13 true/false items. Scores can range 0-13.", "Individual's age (in years)", "Whether participant idenitfied as male (1) or female (0)", "Attitude to science and faith. Response to the question - We rely too much on science and not enough on faith. Responses were recorded on a 5-point scale from strongly disagree (0) to strongly agree (4)", "Number of explicitly mentioned target phrases in response to the question - Please tell me, in your own words, what it means to study something scientifically?" )
) %>% gt::gt()
```

__Preview__

The first six rows of the data are:

```{r echo=FALSE, message=FALSE}
read_csv('https://uoepsy.github.io/data/science-faith-attitude.csv') %>% head %>% gt::gt()
```

`r optend()`

<div class="divider div-transparent div-dot"></div>

# Setup

`r qbegin("Setup", qlabel = FALSE)`  

1. Create a new RMarkdown file
2. Load the required package(s)
3. Read in the science-faith-attitude dataset into R, assigning it to an object named `ebsurvey` 
 
`r qend()`

`r solbegin(show=params$SHOW_SOLS, toggle=params$TOGGLE)`

```{r message=FALSE}
#load packages
library(tidyverse) 
library(psych)
library(patchwork)
library(sjPlot)
library(kableExtra)
library(car)

#read in data
ebsurvey <- read_csv("https://uoepsy.github.io/data/science-faith-attitude.csv")
```

`r solend()`

<div class="divider div-transparent div-dot"></div>

# Exercises 

## Study Overview & Data Management

`r qbegin(1)`

Examine the dataset, and perform any necessary and appropriate data management steps.

Note, to address the research question, we only need to refer to the `kstot`, `age`, and `toomuchscience` variables. Subset the data to only have those 3 columns.

:::{.callout-tip appearance="simple" collapse="true"}

### Hint
- Check for missing data
- If needed, provide better variable names

:::

`r qend()`

`r solbegin(show=params$SHOW_SOLS, toggle=params$TOGGLE)`

```{r}
# Inspect top 6 rows
head(ebsurvey)

# Check data dimensions
dim(ebsurvey)
```

There are `r nrow(ebsurvey)` observations on `r ncol(ebsurvey)` variables.

However, today we will be only using the `kstot`, `age`, and `toomuchscience` variables, and so we subset the data to only include these:

```{r}
ebsurvey <- ebsurvey %>%
    select(kstot, age, toomuchscience)
```

Are there any `NA` values in the data?
```{r}
#check for NAs
anyNA(ebsurvey)

#how many NAs?
table(is.na(ebsurvey))
#11390 NAs in data set 

#Omit the NAs
ebsurvey <- na.omit(ebsurvey)

# Check new data dimensions
dim(ebsurvey)
```

Give the variables more meaningful names. Rename `kstot` to `science_knowledge` and rename `toomuchscience` to `attitude`:

```{r}
ebsurvey <- ebsurvey %>%
    rename(science_knowledge = kstot,
           attitude = toomuchscience)
head(ebsurvey)
```

`r solend()`

<br>

`r qbegin(2)`

Provide a brief overview of the study design and data, before detailing your analysis plan to address the research question.

:::{.callout-tip appearance="simple" collapse="true"}

### Hint 

- Give the reader some background on the context of the study
- State what type of analysis you will conduct in order to address the research question
- Specify the model to be fitted to address the research question (note that you will need to specify the reference level of your categorical variable)
- Specify your chosen significance ($\alpha$) level
- State your hypotheses

Much of the information required can be found in the [Study Overview] codebook.

:::

`r qend()`

`r solbegin(show=params$SHOW_SOLS, toggle=params$TOGGLE)`

The `ebsurvey` dataset, excluding missing values, included 10,503 individual respondents who were measured on 3 different attributes: (1) score on a science "quiz" composed of 13 true/false items; (2) attitudes towards science and faith (question wording: "We rely too much on science and not enough on faith" with responses recorded on a 5-point scale from strongly disagree to strongly agree); and (3) their age (in years).

Histograms will be used to visualise the marginal distributions of attitudes towards science and faith, scientific knowledge, and age. To understand the strength of association among the variables, we will estimate the the correlation coefficients. To address the research question of whether there is an association between people’s scientific knowledge and their attitudes towards science and faith after accounting for their age, we are going to fit the following multiple linear regression model:

$$
 \text{Attitude} = \beta_0  + \beta_1 \cdot \text{Science Knowledge} + \beta_2 \cdot \text{Age} + \epsilon
$$
Effects will be considered statistically significant at $\alpha = .05$.

Our hypotheses are:

$H_0: \beta_1 = 0$: There is no association between people’s scientific knowledge and their attitudes towards science and faith after accounting for their age

$H_1: \beta_1 \neq 0$: There is an association between people’s scientific knowledge and their attitudes towards science and faith after accounting for their age

`r solend()`

<div class="divider div-transparent div-dot"></div>

## Descriptive Statistics & Visualisations

`r qbegin(3)`

Alongside descriptive statistics, visualize the marginal distributions of the `attitude`, `science_knowledge`, and `age` variables. 

:::{.callout-tip appearance="simple" collapse="true"}

### Hint 

*Code for tables & plots*
- You might be able to re-use some of the code you wrote for [Lab 1](https://uoepsy.github.io/dapr2/2324/labs/1_01_slr.html) here, and remember that you can refer back to the [DAPR1 materials](https://uoepsy.github.io/dapr1/2223/index.html) too

*Plot interpretation*  
- The *shape*, *center* and *spread* of the distribution  
- Whether the distribution is *symmetric* or *skewed*  
- Whether the distribution is *unimodal* or *bimodal* 

*Plotting tips*  
- Use `\n` to wrap text in your titles and or axis labels  
- The **patchwork** package allows us to arrange multiple plots in two ways - `|` arranges the plots adjacent to one another, and `/` arranges the plots on top of one another  

*Table tips*  
- The `describe()` function from the **psych** package will produce a table of descriptive statistics. If you would like only a subset of this output (e.g., mean, sd), you can use `select()` after calling `describe()` e.g., `describe() %>% select(mean, sd)`  
- The **kableExtra** package allows us to produce well formatted tables for our descriptive statistics. To do so, you need to specify the `kable()` and `kable_styling()` arguments  
- Review the guidance on the [rmd bootcamp](https://uoepsy.github.io//rmd-bootcamp/), particularly Lesson 4

:::

`r qend()`

`r solbegin(show=params$SHOW_SOLS, toggle=params$TOGGLE)`

::: {.panel-tabset}

## Numeric

```{r}
#| label: tbl-w9-desc
#| tbl-cap: Attitude, Scientfic Knowledge, and Age Descriptive Statistics
ebsurvey %>% 
    describe() %>%
    kable(caption = "Attitude, Scientfic Knowledge, and Age Descriptive Statistics", align = "c", digits = 2) %>%
    kable_styling(full_width = FALSE)

```

## Visual

::: {.panel-tabset}

### Age

You may wish to consider using helpful bin sizes, see the `bindwidth` argument, but this is subjective and optional.
```{r}
ggplot(ebsurvey, aes(x = age)) +
    geom_histogram() +
    labs(x = 'Age (years)', 
         y = 'Frequency')
```

:::{.callout-important icon=false appearance="minimal"}

The mean age in the sample is about 45 years with a standard deviation of just over 17 years. The distribution looks approximately normal, with a slight positive skew.

:::

### Science Knowledge

```{r}
ggplot(ebsurvey, aes(x = science_knowledge)) +
    geom_histogram() +
    labs(x = 'Science Knowledge Quiz Scores', 
         y = 'Frequency')
```

:::{.callout-important icon=false appearance="minimal"}

The histogram shows that the majority of values on the science knowledge quiz score cluster between about 5 and 11. There is a slight negative skew to the distribution. Overall there is little reason for concern as to the appropriateness of the variable for inclusion.

:::

### Attitude Towards Science & Faith

```{r}
ggplot(ebsurvey, aes(x = attitude)) +
    geom_histogram() +
    labs(x = 'We Rely too Much on Science and not Enough on Faith', 
         y = 'Frequency')
```

:::{.callout-important icon=false appearance="minimal"}

The mean score on the science and faith attitude variable is just over 2. There are only 5 discrete values possible in the distribution, based on the response options available, but the distribution looks approximately normal, with a slight negative skew.

:::

:::

:::

`r solend()`

<br>

`r qbegin(4)`

Produce plots of the associations between the outcome variable (attitude) and each of the explanatory variables.

:::{.callout-tip appearance="simple" collapse="true"}

### Hint 

*Plot interpretation*    
- *Direction* of association  
- *Form* of association (can it be summarised well with a straight line?)  
- *Strength* of association (how closely do points fall to a recognizable pattern such as a line?)  
- *Unusual observations* that do not fit the pattern of the rest of the observations and which are worth examining in more detail  

*Plot tips*  
- use `\n` to wrap text in your titles and or axis labels  
- consider using `geom_smooth()` to  superimpose the best-fitting line describing the association of interest

:::

`r qend()`

`r solbegin(show=params$SHOW_SOLS, toggle=params$TOGGLE)`

```{r message = FALSE, warning=FALSE}
#| label: fig-marg-relationship
#| fig-cap: "Scatterplots displaying the associations between Attitude towards Science and Faith and a) Age, and b) Science Knowledge"
p1 <- ggplot(data = ebsurvey, aes(x = age, y = attitude)) +
    geom_point() +
  geom_smooth(method = "lm", se = FALSE) + 
    labs(x = 'Age (in years)', y = "Attitude towards Science and Faith")

p2 <- ggplot(data = ebsurvey, aes(x = science_knowledge, y = attitude)) +
    geom_point()  +
  geom_smooth(method = "lm", se = FALSE) + 
    labs(x = "Science Knowledge Quiz Scores", y = "Attitude towards Science and Faith")

p1 | p2 
```

From the pairwise scatterplots, it does not seem like there is a strong linear dependence of attitude to science and faith on a person's age and science knowledge.

`r solend()`

<br>

`r qbegin(5)`

Produce a correlation matrix of the variables which are to be used in the analysis, and write a short paragraph describing the associations. 

:::{.callout-tip appearance="simple" collapse="true"}

### Hint 

*Correlation Matrix*  
Review [Lab 1 Q2](https://uoepsy.github.io/dapr2/2324/labs/1_01_slr.html#associations-among-variables) for guidance on how to produce a correlation matrix.

*APA Format*  
Make sure to round your numbers in-line with APA 7th edition guidelines as noted at the start of the lab (see 'Presenting Results'). The `round()` function will come in handy here. 

:::

`r qend()`

`r solbegin(show=params$SHOW_SOLS, toggle=params$TOGGLE)`

We can either index the dataframe or select the variables of interest:

::: {.panel-tabset}

## Index dataframe (`[]`)

```{r}
# correlation matrix of the three columns of interest (check which columns we need - in this case, 1,2,3)
round(cor(ebsurvey[,c(1:3)]), digits = 2)
```

## Variable selection (`select()`)

```{r}
# select only the columns we want by variable name, and pass this to cor()
ebsurvey %>% 
  select(attitude, science_knowledge, age) %>%
  cor() %>%
  round(digits = 2)
```

:::

::: {.callout-important icon=false appearance="minimal"}

+ There was a weak, positive, linear association between attitude towards science and faith and age for the participants in the sample $(r = .05)$
+ There was a weak, negative, linear association between attitude towards science and faith and scientific knowledge for the participants in the sample $(r = -.18)$
+ There was a weak, negative, linear association between scientific knowledge and age for the participants in the sample $(r = -.12)$. The correlation is relatively small in absolute terms, and we therefore have little concern about multicollinearity influencing this regression analysis
+ Overall, there were very weak linear associations among the variables of interest

:::

`r solend()`

<div class="divider div-transparent div-dot"></div>

## Model Fitting & Interpretation 

`r qbegin(6)`

Fit the specified model, and assign it the name "att_mdl".  

$$
 \text{Attitude} = \beta_0  + \beta_1 \cdot \text{Science Knowledge} + \beta_2 \cdot \text{Age} + \epsilon
$$
`r qend()`

`r solbegin(show=params$SHOW_SOLS, toggle=params$TOGGLE)`

```{r}
att_mdl <- lm(attitude ~ science_knowledge + age, data = ebsurvey)
```

`r solend()`

<br>

`r qbegin(7)`

Check the assumptions of your model. Note any violations of the model assumptions.

`r qend()`

`r solbegin(show=params$SHOW_SOLS, toggle=params$TOGGLE)`


```{r out.width = '95%'}
par(mfrow = c(2,2)) # set 2 by 2 panels
plot(att_mdl)
par(mfrow = c(1,1)) # go back to 1 by 1 panels
```

Based on the visual inspection of the plots, the assumptions appear to be violated.

`r solend()`

<br>

`r qbegin(8)`

Bootstrap your model. 

Interpret your coefficients in the context of the study.

`r qend()`

`r solbegin(show=params$SHOW_SOLS, toggle=params$TOGGLE)`

```{r}
#Run model
boot_mdl <- Boot(att_mdl, R = 1000)
```

```{r}
#check summary
summary(boot_mdl)
```

::: {.panel-tabset}

## Intercept

The results in Table \@ref(tab:tbl-boot) report an estimate of the intercept (or constant) as equal to approximately 2.79. 
The constant of a multiple regression model can be interpreted as the average expected value of the dependent variable when all of the independent variables equal zero. In this case, the independent variable science knowledge has only a handful of respondents that score zero, and no one is aged zero, so the constant by itself does not tell us much. Researchers do not often have predictions based on the intercept, so it often receives little attention. A better choice would be to mean centre age, and refit the model with a mean centred age variable!

## Science knowledge

The estimated value for the slope coefficient linking knowledge to attitude is estimated to be approximately -0.08. This represents the average marginal effect of knowledge on attitude, and can be interpreted as the expected change in the dependent variable on average for a one-unit increase in the independent variable, controlling for age. In this example, every increase in quiz score by one point is associated with a decrease in attitude score of about –0.08, adjusted for age. 
Bearing in mind the valence of the question wording, this means that those who are more knowledgeable tend to be more favourable towards science – i.e. disagreeing with the statement.

## Age

The slope coefficient linking age to attitude is estimated to be approximately 0.002. This represents the average marginal effect of each additional year on attitude, and can be interpreted as the expected change in the dependent variable on average for a one-unit increase in the independent variable, controlling for science knowledge. For this example, that means that for every year older a person is, their attitude score is expected to increase by 0.002, controlling for science knowledge. This may seem like a very small effect, but remember that this is the effect of only one additional year. Bearing in mind the valence of the question wording, this means that older people tend to be less favourable towards science – i.e. agreeing with the statement.

:::

`r solend()`

<br>

`r qbegin(9)`

Obtain confidence intervals for your bootstrapped model estimates.  

`r qend()`

`r solbegin(show=params$SHOW_SOLS, toggle=params$TOGGLE)`

You can use your preferred confidence level here, but by default this is 95%:

```{r}
Confint(boot_mdl, level = 0.95, type = "perc")
```

The `type = "perc"` argument tells `R` to return the values that comprise 95% of all values in between them, i.e. the value with 2.5% of observations below it and the value with 2.5% of observations above it and 97.5% of observations below it.

If you want to make it into a nice table:

```{r tbl-boot}
Confint(boot_mdl, type = "perc") %>%
    kable(digits = 3, caption = 'Bootstrap 95% CIs') %>%
    kable_styling(full_width = FALSE)
```

::: {.callout-important icon=false appearance="minimal"}

+ We are 95% confident that the population intercept is between 2.68 and 2.90  
+ We are 95% confident that the population slope for science knowledge is between -0.09 and -0.07  
+ We are 95% confident that the population slope for age is between 0.001 and 0.004  

The bootstrap confidence intervals table containing the 95% confidence intervals for both slope estimates do not include 0. This leads us to reject both null hypotheses at the 5% significance level, and conclude that there appear to be associations between both attitude to science and faith and age, and for attitude to science and faith with science knowledge. 

:::

`r solend()`

<div class="divider div-transparent div-dot"></div>

## Writing Up & Presenting Results

`r qbegin(10)`

Interpret the results from your bootstrapped model in the context of the research question.

Provide key model results in a formatted table, and refer to this in your write-up. 

:::{.callout-tip appearance="simple" collapse="true"}

### Hint 

Make sure to include a decision in relation to your null hypothesis - based on the evidence, should you reject or fail to reject the null?  

:::

`r qend()`

`r solbegin(show=params$SHOW_SOLS, toggle=params$TOGGLE)`

We used a subset of data from the 2005 Eurobarometer 63.1 survey to investigate whether:

- There is a significant linear relationship between people’s age and their attitudes to science and faith after accounting for their scientific knowledge.
- There is a significant linear relationship between people’s scientific knowledge and their attitudes to science and faith after accounting for their age.


Figure \@ref(fig:res-descr-plot) displays the scatterplots of the pairwise relationships between the 3 variables. From the plot and the correlation matrix, displyed in Table \@ref(tab:res-descr-cor), it appears that there is a weak negative linear association between attitude and science knowledge, and nearly no linear association between attitude and age.

```{r res-descr-plot, echo=FALSE, out.width='95%', fig.height = 4, fig.width=12, fig.cap = "Pairwise scatterplots of the variables."}
p1 | p2
```

```{r res-descr-cor, echo=FALSE}
cor(ebsurvey) %>%
    kable(digits = 3, caption = "Correlation matrix") %>%
    kable_styling(full_width = FALSE)
```




To answer the research hypotheses, we fitted the following regression model:
$$
\text{Attitude} = \beta_0 + \beta_1 \cdot \text{Science Knowledge} + \beta_2 \cdot \text{Age} + \epsilon
$$

```{r echo=FALSE}
b0 <- signif(coef(att_mdl)[1],2)
b1 <- signif(coef(att_mdl)[2],2)
b2 <- signif(coef(att_mdl)[3],2)
```

Which resulted in the following estimated regression coefficients for the original sample:
$$
\widehat{\text{Attitude}} = `r b0` `r b1` \cdot \text{Science Knowledge} + `r b2` \cdot \text{Age}
$$

The model does not satisfy the regression assumptions, see Figure \@ref(fig:res-diag-plots), and for this reason we will assess statistical significance using the boostrap approach with $R = 1000$ resamples.

```{r res-diag-plots, echo=FALSE, fig.cap = "Diagnostic plots", out.width = '95%'}
par(mfrow = c(2,2))
plot(att_mdl)
```

```{r resboottable, echo=FALSE}
Confint(boot_mdl, type = "perc") %>%
    knitr::kable(., "html", digits = 3, caption = 'Bootstrap 95% CIs') %>%
    kable_styling(full_width = FALSE,)
```

The 95% bootstrap confidence intervals are provided in Table \@ref(tab:resboottable). 
These results displayed suggest that there is a negative and statistically significant relationship between knowledge of science and attitude to science and faith. Specifically, the results show that for every additional correct quiz answer people give, we would expect the attitude score to be lower by about 0.08. For age, the effect is in the opposite direction. For every additional year older a person is, they are expected to score .002 more on the attitude scale. The R-squared for the model is 0.032, which means that approximately 3% of the variance in attitude is explained by science knowledge and age. This leaves the majority of variation in attitudes unexplained by our model. Thus we conclude that respondents with greater knowledge about science also tend to be more positive about it, regardless of their age, while older people are slightly less positive, irrespective of their level of knowledge. 

`r solend()`

<div class="divider div-transparent div-dot"></div>

# Compile Report

`r qbegin("Compile Report", qlabel = FALSE)`  

Knit your report to PDF, and check over your work. To do so, you should make sure:

- Only the output you want your reader to see is visible (e.g., do you want to hide your code?)
- Check that the **tinytex** package is installed
- Ensure that the ‘yaml’ (bit at the very top of your document) looks something like this:

```{}
---
title: "this is my report title"
author: "B1234506"
date: "07/09/2024"
output: bookdown::pdf_document2
---
```

:::{.callout-tip appearance="simple" collapse="true"}
# What to do if you cannot knit to PDF
If you are having issues knitting directly to PDF, try the following:  

- Knit to HTML file  
- Open your HTML in a web-browser (e.g. Chrome, Firefox)  
- Print to PDF (Ctrl+P, then choose to save to PDF)  
- Open file to check formatting
:::

:::{.callout-tip appearance="simple" collapse="true"}
# Hiding Code and/or Output

:::{.panel-tabset}
## Hiding R Code

To not show the code of an R code chunk, and only show the output, write:

````
```{{r, echo=FALSE}}
# code goes here
```
````

## Hiding R Output

To show the code of an R code chunk, but hide the output, write:

````
```{{r, results='hide'}}
# code goes here
```
````

## Hiding R Code and Output

To hide both code and output of an R code chunk, write:

````
```{{r, include=FALSE}}
# code goes here
```
````
:::

:::

:::{.callout-tip appearance="simple" collapse="true"}

### Tinytex
You must make sure you have **tinytex** installed in R so that you can “Knit” your Rmd document to a PDF file:

```{r eval = FALSE}
install.packages("tinytex")
tinytex::install_tinytex()
```

:::

`r qend()`

`r solbegin(show = params$SHOW_SOLS, toggle = params$TOGGLE)`

You should end up with a PDF file. If you have followed the above instructions and still have issues with knitting, speak with a Tutor. 

`r solend()`
