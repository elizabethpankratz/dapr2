---
title: "Interactions I: Num x Cat"
link-citations: yes
params: 
    SHOW_SOLS: TRUE
    TOGGLE: TRUE
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
source('assets/setup.R')
library(tidyverse)
library(tidyverse)
library(psych)
library(sjPlot)
library(patchwork)
library(kableExtra) 
library(plotly)
library(pander)
set.seed(953)
```

:::lo
### <i class="fa fa-graduation-cap"></i> Learning Objectives
At the end of this lab, you will:

1. Understand the concept of an interaction.
2. Be able to interpret the meaning of a numeric $\times$ categorical interaction.
3. Visualize and probe interactions.

### <i class="fa fa-check-square-o fa-2"></i> What You Need

1. Be up to date with lectures
2. Have completed all labs from Semester 1 Block 1 (Weeks 1 - 5)

### <i class="fab fa-r-project"></i> Required R Packages
Remember to load all packages within a code chunk at the start of your RMarkdown file using `library()`. If you do not have a package and need to install, do so within the console using `install.packages(" ")`. For further guidance on installing/updating packages, see Section C [here](https://uoepsy.github.io/files/install-update-r#update-pkgs). 

For this lab, you will need to load the following package(s):

* **tidyverse** 
* **psych** 
* **patchwork** 
* **sandwich**
* **interactions**

### <i class="fa fa-file"></i> Lab Data
You can download the data required for this lab [here](https://uoepsy.github.io/data/wellbeing_rural.csv) or read it in via this link https://uoepsy.github.io/data/wellbeing_rural.csv. 

:::

# Study Overview 

> **Research Question** 
>
> Does the association between number of social interactions and wellbeing differ between rural and non-rural residents?  

Researchers were specifically interested in how the number of social interactions might influence mental health and wellbeing differently for those living in rural communities compared to those in cities and suburbs. They want to assess whether the effect of social interactions on wellbeing _is moderated by_ (depends upon) whether or not a person lives in a rural area. 

To investigate how the association between the number of social interactions and mental wellbeing might be different for those living in rural communities, the researchers conducted a study, where they collected data from 200 randomly selected residents of the Edinburgh & Lothian postcodes. 

`r optbegin("Wellbeing/Rurality data codebook.", olabel=FALSE, toggle=params$TOGGLE)`  

__Description__

From the Edinburgh & Lothians, 100 city/suburb residences and 100 rural residences were chosen at random and contacted to participate in the study. The Warwick-Edinburgh Mental Wellbeing Scale (WEMWBS), was used to measure mental health and well-being. 

Participants filled out a questionnaire including items concerning: estimated average number of hours spent outdoors each week, estimated average number of social interactions each week (whether on-line or in-person), whether a daily routine is followed (yes/no). For those respondents who had an activity tracker app or smart watch, they were asked to provide their average weekly number of steps.  
  
The data in `wellbeing.csv` contain seven attributes collected from a random sample of $n=200$ hypothetical residents over Edinburgh & Lothians, and include:  

- `wellbeing`: Warwick-Edinburgh Mental Wellbeing Scale (WEMWBS), a self-report measure of mental health and well-being. The scale is scored by summing responses to each item, with items answered on a 1 to 5 Likert scale. The minimum scale score is 14 and the maximum is 70.  
- `outdoor_time`: Self report estimated number of hours per week spent outdoors  
- `social_int`: Self report estimated number of social interactions per week (both online and in-person)
- `routine`: Binary 1=Yes/0=No response to the question "Do you follow a daily routine throughout the week?"
- `location`: Location of primary residence (City, Suburb, Rural)
- `steps_k`: Average weekly number of steps in thousands (as given by activity tracker if available)
- `age`: Age in years of respondent

__Preview__

The first six rows of the data are:

```{r echo=FALSE}
read_csv('https://uoepsy.github.io/data/wellbeing_rural.csv') %>% head %>% gt::gt()
```
  
`r optend()`

# Setup

`r qbegin("Setup", qlabel = FALSE)`  

1. Create a new RMarkdown file
2. Load the required package(s)
3. Read the wellbeing_rural dataset into R, assigning it to an object named `wrdata`
 
`r qend()`

`r solbegin(show=params$SHOW_SOLS, toggle=params$TOGGLE)`
```{r message=FALSE}
#Loading the required package(s)
library(tidyverse)
library(psych)
library(patchwork)
library(sandwich)
library(interactions)

#Reading in data and storing in object named 'wrdata'
wrdata <- read_csv("https://uoepsy.github.io/data/wellbeing_rural.csv")
```

`r solend()`

## Exercises

`r qbegin(1)`

Formally state:

- a linear model to investigate if the association between wellbeing and social interactions differs among rural and non-rural residents
- your chosen significance level
- the null and alternative hypotheses

:::quote
"Except in special circumstances, a model including a product term for interaction between two explanatory variables should also include terms with each of the explanatory variables individually, even though their coefficients may not be significantly different from zero. Following this rule avoids the logical inconsistency of saying that the effect of $X_1$ depends on the level of $X_2$ but that there is no effect of $X_1$."  
--- @Ramsey2012
:::

`r qend()`

`r solbegin(show=params$SHOW_SOLS, toggle=params$TOGGLE)`

To address the research question, we are going to fit the following model, where $y$ = wellbeing; $x_1$ = social interactions; and $x_2$ = whether or not the respondent lives in a rural location. 

$$
y = \beta_0 + \beta_1  x_1 + \beta_2  x_2 + \beta_3 (x_1 \cdot x_2) + \epsilon \\ 
\quad \\ \text{where} \quad \epsilon \sim N(0, \sigma) \quad \text{independently}
$$
or 
$$
\text{Wellbeing} = \beta_0 + \beta_1 \cdot Social Interactions + \beta_2 \cdot Location_{Rural}  + \beta_3 \cdot (Social Interactions \cdot Location_{Rural}) + \epsilon \\ 
$$

Effects will be considered statistically significant at $\alpha=.05$

Our hypotheses are:

$H_0: \beta_3 = 0$

The association between wellbeing and social interactions is not moderated by whether or not a person lives in a rural area. 

$H_1: \beta_3 \neq 0$

The association between wellbeing and social interactions is moderated by whether or not a person lives in a rural area. 

`r solend()`

<br>

`r qbegin(2)`

Check coding of variables (e.g., that categorical variables are coded as factors). 

Note that the "location" variable currently has three levels (Rural/Suburb/City), but we only want two (Rural/Not Rural) in order to address our research question, you'll need to fix this. One way to do this would be to use `ifelse()` to define a variable which takes one value ("Rural") if the observation meets from some condition, or another value ("Not Rural") if it does not. 

Specify 'not rural' as your reference group.

:::{.callout-tip appearance="simple" collapse="true"}

### Hint

Type `?ifelse` in the *console* if you want to see the help function. You can use it to add a new variable either inside `mutate()`, or using `data$new_variable_name <- ifelse(test, x, y)` syntax.

:::

`r qend()`

`r solbegin(show=params$SHOW_SOLS, toggle=params$TOGGLE)`

Create a new variable for Rural/Not Rural:
```{r}
wrdata <- wrdata %>% 
  mutate(
    isRural = ifelse(location == "rural", "rural", "not rural")
  )
```

Check coding of variables within `wrdata` and ensure `isRural` is a factor with two levels, 'rural' and 'not rural':
```{r}
str(wrdata) #overall 'structure of data. Or could run is.factor()
wrdata$isRural <- as_factor(wrdata$isRural)
is.factor(wrdata$isRural) #check that isRural is now a factor
```

```{r}
#specify 'not rural' as reference group
wrdata$isRural <- relevel(wrdata$isRural, 'not rural')
```

`r solend()`

<br>

`r qbegin(3)`

Visualise your data. 

In particular:

1. Explore the associations among the variables included in your analysis
2. Produce a visualisation of the association between weekly number of social interactions and well-being, with separate _facets_ for rural vs non-rural respondents **OR** with different colours for each level of the `isRural` variable.

:::{.callout-tip appearance="simple" collapse="true"}

### Hint

1. The `pairs.panels()` function from the `psych` package will plot all variables in a dataset against one another. This will save you the time you would have spent creating individual plots.  

2. Within your `ggplot()` argument, you will need to specify `+ facet_wrap()` in order to produce facets for each location. It would also be useful to specify `  geom_smooth(method="lm")`

:::

`r qend()`

`r solbegin(show=params$SHOW_SOLS, toggle=params$TOGGLE)`

Let's first plot the variables included within our model (note that we could use this for the whole dataset, but we don't want to include irrelevant variables):

```{r}
wrdata %>% 
  select(wellbeing, social_int, isRural) %>%
  pairs.panels()
```

Next, lets produce our plots with a facet for rural vs non-rural residents: 

```{r}
ggplot(data = wrdata, aes(x = social_int, y = wellbeing)) +
  geom_point() +
  geom_smooth(method="lm", se=FALSE) +
  facet_wrap(~isRural) 
```

Or different colours for location (rural vs rural):

```{r}
ggplot(data = wrdata, aes(x = social_int, y = wellbeing, colour = isRural)) +
  geom_point() + 
  geom_smooth(method="lm", se=FALSE) +
    scale_colour_discrete(
    name ="Location",
    labels=c("Not Rural", "Rural"))
```

`r solend()`

<br>

`r qbegin(4)`

Fit your model using `lm()`, and assign it as an object with the name "rural_mod".   

:::{.callout-tip appearance="simple" collapse="true"}

### Hint

When fitting a regression model in `R` with two explanatory variables A and B, and their interaction, these two are equivalent:  

+ y ~ A + B + A:B
+ y ~ A*B  

:::

`r qend()`

`r solbegin(show=params$SHOW_SOLS, toggle=params$TOGGLE)`

```{r}
#fit model including interaction between social_int and isRural
rural_mod <- lm(wellbeing ~  social_int * isRural, data = wrdata)

#check model output
summary(rural_mod)
```

`r solend()`

:::statbox
## Interpretation coefficients

__Interpreting coefficients for A and B in the presence of an interaction A:B__   

When you include an interaction between $x_1$ and $x_2$ in a regression model, you are estimating the extent to which the effect of $x_1$ on $y$ is different across the values of $x_2$.  

What this means is that the effect of $x_1$ on $y$ *depends on/is conditional upon* the value of $x_2$.  
(and vice versa, the effect of $x_2$ on $y$ is different across the values of $x_1$).   
This means that we can no longer talk about the "effect of $x_1$ _holding $x_2$ constant_". Instead we can talk about a _marginal effect_ of $x_1$ on $y$ at a specific value of $x_2$. 

:::frame
When we fit the model $y = \beta_0 + \beta_1 x_1 + \beta_2 x_2 + \beta_3 (x_1 \cdot x_2) + \epsilon$ using `lm()`:  

- the parameter estimate $\hat \beta_1$ is the _marginal effect_ of $x_1$ on $y$ where $x_2 = 0$  
- the parameter estimate $\hat \beta_2$ is the _marginal effect_ of $x_2$ on $y$ where $x_1 = 0$  
:::

<div style="margin-left: 15px">
<small>
__N.B.__ Regardless of whether or not there is an interaction term in our model, all parameter estimates in multiple regression are "conditional" in the sense that they are dependent upon the inclusion of other variables in the model. For instance, in $y = \beta_0 + \beta_1 x_1 + \beta_2 x_2 + \epsilon$ the coefficient $\hat \beta_1$ is conditional upon holding $x_2$ constant. 
</small>
</div>

__Interpreting the interaction term A:B__  

The coefficient for an interaction term can be thought of as providing an _adjustment to the slope._   
  
In the model below, we have a numeric*categorical interaction:

$$
\text{wellbeing} \ = \beta_0 + \beta_1 \cdot Social Interactions + \beta_2 \cdot Location_{Rural}  + \beta_3 \cdot (Social Interactions \cdot Location_{Rural}) + \epsilon  
$$

The estimate $\hat \beta_3$ is the adjustment to the slope $\hat \beta_1$ to be made for the individuals in the $\text{isRural}=1$ group. 

:::


`r qbegin(5)`  
Look at the parameter estimates from your model, and write a description of what each one corresponds to on the plot shown in @fig-annotate-int (it may help to sketch out the plot yourself and annotate it).  

:::quote
"The best method of communicating findings about the presence of significant interaction may be to present a table of graph of the estimated means at various combinations of the interacting variables."    
--- @Ramsey2012  
:::


```{r fig-annotate-int, echo=FALSE, message = FALSE, fig.cap="Multiple regression model: Wellbeing ~ Social Interactions * is Rural<br><small>Note that the dashed lines represent predicted values below the minimum observed number of social interactions, to ensure that zero on the x-axis is visible</small>"}
#| label: fig-annotate-int
#| fig-cap: "Multiple regression model: Wellbeing ~ Social Interactions * is Rural"
nd = expand_grid(social_int=0:13,isRural=c("rural","not rural"))
nd = nd %>% mutate(wellbeing = predict(rural_mod, newdata = .))
sjPlot::plot_model(rural_mod, type="int")+
  scale_fill_manual(NULL, values=c(NA,NA))+xlim(0,28)+
  geom_line(inherit.aes=FALSE,data=nd,aes(x=social_int,col=isRural,y=wellbeing), lty="longdash")+
  scale_x_continuous(expand = c(0, 0)) + scale_y_continuous(expand = c(0, 1))
```

`r optbegin("Options", olabel=FALSE, toggle=params$TOGGLE)`
Here are some options to choose from:

+ The point at which the blue line cuts the y-axis (where social_int = 0)
+ The point at which the red line cuts the y-axis (where social_int = 0)
+ The average vertical distance between the red and blue lines. 
+ The vertical distance from the blue to the red line _at the y-axis_ (where social_int = 0)
+ The vertical distance from the red to the blue line _at the y-axis_ (where social_int = 0)
+ The vertical distance from the blue to the red line _at the center of the plot_
+ The vertical distance from the red to the blue line _at the center of the plot_
+ The slope (vertical increase on the y-axis associated with a 1 unit increase on the x-axis) of the blue line
+ The slope of the red line
+ How the slope of the line changes when you move from the blue to the red line
+ How the slope of the line changes when you move from the red to the blue line
`r optend()`

`r qend()`

`r solbegin(show=params$SHOW_SOLS, toggle=params$TOGGLE)`

Recall that we can obtain our parameter estimates using various functions such as `summary()`,`coef()`, `coefficients()`, etc. 

```{r}
coefficients(rural_mod)
```

+ $\beta_0$ = `(Intercept)` = `r round(coef(rural_mod)[1],2)`
    - On plot: The point at which the blue line cuts the y-axis
    - Interpretation: The intercept, or predicted wellbeing score when the number of social interactions per week is 0, and when location is not rural.

+ $\beta_1$ = `social_int` = `r round(coef(rural_mod)[2],2)`
    - On plot: The slope (vertical increase on the y-axis associated with a 1 unit increase on the x-axis) of the blue line.
    - Interpretation: The simple slope of social interactions (number per week) for location reference group (not rural).

+ $\beta_2$ = `isRuralrural` = `r round(coef(rural_mod)[3],2)`
    - On plot: The vertical distance from the blue to the red line _at the y-axis_ (where social_int = 0).  
    - Interpretation: The simple effect of location (or the difference in wellbeing scores between rural and non rural residents) when number of social interactions is 0. 

+ $\beta_3$ `social_int:isRuralrural` = `r round(coef(rural_mod)[4],2)`
    - On plot: How the slope of the line changes when you move from the blue to the red line. 
    - Interpretation: The interaction between social interactions (number per week) and location (rural/not rural) - the difference in the simple slopes of social interactions for rural vs non-rural residents. 


`r solend()`

<br>

:::statbox

__Mean Centering__

Mean centering a variable involves subtracting the mean of that variable from every individual value. When working with models that contain interaction terms (like our `rural_mod`), it is generally a good idea to center your continuous predictor variables. This is because:

- centering helps to address issues of multicollinearity (you'll learn more about this later in the course)
- centering makes the model coefficients easier to interpret
:::

`r qbegin(6)`

Mean center the continuous IV(s), and re-run your model with mean centred variable(s).

`r qend()`

`r solbegin(show=params$SHOW_SOLS, toggle=params$TOGGLE)`

Create mean centred variable for 'social_int':

```{r}
wrdata <-
 wrdata %>%
  mutate(
   mc_social_int = social_int - mean(social_int)
    )
```

Re-run model:

```{r}
#fit model including interaction between social_int and isRural
rural_mod1 <- lm(wellbeing ~  mc_social_int * isRural, data = wrdata)

#check model output
summary(rural_mod1)
```

`r solend()`

<br>

`r qbegin(7)`

Using the `probe_interactions()` function from the interactions package, visualise the interaction effects from your model, and conduct a simple slopes analysis.

`r qend()`

`r solbegin(show=params$SHOW_SOLS, toggle=params$TOGGLE)`

```{r}
plt_rural_mod <- probe_interaction(model = rural_mod, 
                  pred = social_int, 
                  modx = isRural, 
                  cond.int = T,
                  interval = T, 
                  jnplot = T)
```

Let's look at our plot:

```{r}
#| label: fig-int
#| fig-cap: "Interaction Plot"
plt_rural_mod$interactplot
```

From the same function, we can look at the significance of the slopes:

```{r}
plt_rural_mod$simslopes$slopes
```

`r solend()`

<br>

`r qbegin(8)`

Interpret your results (from the mean centred model) in the context of the research question and report your model in full.

Provide key model results in a formatted table, and refer to your interaction plot.

`r qend()`

`r solbegin(show=params$SHOW_SOLS, toggle=params$TOGGLE)`

```{r}
#| label: tbl-rural-mc-modresults
#| tbl-cap: Regression Table for Wellbeing Model
#create table for results
tab_model(rural_mod1,
          dv.labels = "Wellbeing (WEMWBS Scores)",
          pred.labels = c("mc_social_int" = "Social Interactions (number per week)",
                          "isRuralrural" = "Location - Rural",
                          "mc_social_int:isRuralrural" = "Social Interactions * Location - Rural"),
          title = "Regression Table for Wellbeing Model")
```

And now lets write our results up:

::: {.callout-important icon=false appearance="minimal"}

Full regression results including 95% Confidence Intervals are shown in @tbl-rural-mc-modresults. The $F$-test for model utility was significant $(F(3,196) = 27.49, p<.001)$, and the model explained approximately 28.54% of the variability in wellbeing scores.

Therefore, we have evidence to reject the null hypothesis (that the association between wellbeing and social interactions is not moderated by whether or not a person lives in a rural area).

:::

`r solend()`


