---
title: "More Logistic Regression"
link-citations: yes
params: 
    SHOW_SOLS: TRUE
    TOGGLE: TRUE
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
source('assets/setup.R')

set.seed(953)

library(DT)
library(pander)
library(sjPlot)
library(tidyverse)
library(car)

```

:::lo

### <i class="fa fa-graduation-cap"></i> Learning Objectives
At the end of this lab, you will:

1. Understand how to fit and interpret a logistic model
2. Understand the difference between Pearson residuals and Deviance residuals
3. Understand how to evaluate model fit

### <i class="fa fa-check-square-o fa-2"></i> What You Need

1. Be up to date with lectures
2. Have completed Lab 6

### <i class="fab fa-r-project"></i> Required R Packages
Remember to load all packages within a code chunk at the start of your RMarkdown file using `library()`. If you do not have a package and need to install, do so within the console using `install.packages(" ")`. For further guidance on installing/updating packages, see Section C [here](https://uoepsy.github.io/files/install-update-r#update-pkgs). 

For this lab, you will need to load the following package(s):

* **tidyverse** 
* **patchwork**
* **kableExtra**
* **pander**
* **sjPlot**

### <i class="fa fa-file"></i> Lab Data
You can download the data required for this lab [here](https://uoepsy.github.io/data/QuitAttempts.csv) or read it in via this link https://uoepsy.github.io/data/QuitAttempts.csv. 

:::


# Study Overview

> **Research Question**
>
> Does the probability of having senility symptoms change as a function of the WAIS score?

Kalkhoran et al. (2015) [^1] investigated predictors of dual use of cigarettes and smokeless tobacco products. Although their original sample size was large ($n$ = 1324), they were interested in running separate logistic regression analyses within subgroups. Most of the sample used only cigarettes. One of the smaller subgroups contained subjects who used both cigarettes and smokeless tobacco products ($n$=61). For this problem we focus on this smaller subgroup of dual cigarette and smokeless tobacco users. The dependent variable, Q, is whether the subject made an attempt to quit using tobacco products (0 = no attempt to quit; 1 = attempted to quit). There is one multi-category independent variable, intention to quit, I, with four levels: never intend to quit, may intend to quit but not in the next 6 months, intend to quit in the next 6 months, intend to quit in the next 30 days.  

`r optbegin("Senility Codebook", olabel=FALSE, toggle=params$TOGGLE)` 

__Description__

**Method**  
Researchers conducted a study in which they approached 120 people, recruited from within the vicinity of a number of establishments with licenses to sell alcohol to be consumed on-premises. Initially, experimenter A approached participants and asked if they were interested in participating in a short study, and obtained their written consent. While experimenter A subsequently talked each participant through a set of questions on multiple pieces of paper (with the pretense of explaining what the participant was required to do), experimenters B and C carrying a door passed between the participant and experimenter A, with experimenter C replacing A (as can be viewed in the video). 

The perceptual load of the experiment was manipulated via a) the presentation of the door and b) the papers held by the experimenters. For 60 of these participants, the door was painted with some detailed graffiti and had a variety of pieces of paper and notices attached to the side facing the participants. Additionally, for these participants, the experimenters handled a disorganised pile of 30 papers, with the top pages covered in drawings around the printed text. For the remaining 60, the door was a standard MDF construction painted a neutral grey, and the experimenters handled only 2 sheets of paper which had minimal printed text on them and nothing else. 

**Measures**   
After experimenters A and C had successfully swapped positions, the participant was asked (now by C) to complete small number of questions taking approximately 1 minute. Either after this set of questions, or if the participant made an indication that they had noticed the swap, the experimenters regrouped and the participant was explicitly asked whether they had noticed the swap.   

Immediately after this, participants were breathalysed, and their blood alcohol content was recorded.  

__Preview__

The first six rows of the data are:

```{r echo=FALSE, message=FALSE}
read_csv('https://uoepsy.github.io/data/QuitAttempts.csv') %>% head %>% gt::gt()
```

`r optend()`

# Setup

`r qbegin("Setup", qlabel = FALSE)`  

1. Create a new RMarkdown file
2. Load the required package(s)
3. Read in the 'SenilityWAIS' dataset into R, assigning it to an object named `sen` 
 
`r qend()`

`r solbegin(show=params$SHOW_SOLS, toggle=params$TOGGLE)`

```{r message=FALSE}
#load packages
library(tidyverse)
library(psych)
library(kableExtra)
library(ggmosaic)
library(patchwork)
library(sjPlot)

#read in data
smoke <- read_csv("https://uoepsy.github.io/data/QuitAttempts.csv")
```

`r solend()`

<br>

`r qbegin(1)`

Examine the dataset, and perform any necessary and appropriate data management steps.

`r qend()`

`r solbegin(show=params$SHOW_SOLS, toggle=params$TOGGLE)`

```{r}
#look at structure of data:
str(smoke)

#check for NAs - there are none - all FALSE:
table(is.na(smoke))

#re-name variables to improve clarity:
smoke <- smoke %>%
    rename(PID = S,
           Quitting = Q,
           Intention = I)

#designate intention as a factor:
smoke$Intention <- as_factor(smoke$Intention)

```

`r solend()`

<br>

`r qbegin(2)`

Provide a table of descriptive statistics and visualise your data.

Remember to interpret your plot in the context of the study. 

:::{.callout-tip appearance="simple" collapse="true"}

### Hint

1. For your table of descriptive statistics, both the `group_by()` and `summarise()` functions will come in handy here.
2. Recall that when visualising a continuous outcome across several groups, `geom_boxplot()` may be most appropriate to use.
3. Make sure to comment on any observed differences among the sample means of the four treatment conditions.

:::

`r qend()`

`r solbegin(show=params$SHOW_SOLS, toggle=params$TOGGLE)`

Let's first produce a descriptive statistics table:

```{r message=FALSE, warning=FALSE}
#| label: tbl-cog-descript
#| tbl-cap: Descriptive Statistics
smoke_stats <- smoke %>%
    select(Intention, Quitting) %>%
    table() %>%
    kable(caption = "Descriptive Statistics") %>%
    kable_styling()

smoke_stats
```

Our view as proportions: 
```{r}
smoke %>%
  group_by(Intention, Quitting) %>%
  summarise(
    n = n()) %>%
  mutate(
    Prop = round(n/sum(n),2)
  )
```


We can explore the association between the two categorical variables as follows:

```{r}
#| label: fig-smoke-desc
#| fig-cap: "Association between Intention and Quitting Attempt"
smoke_plt1 <- ggplot(data = smoke, aes(x=Intention, fill=as_factor(Quitting))) +
  geom_bar(position = "dodge") +
  labs(fill = 'Attempted Quitting?', xlab = "Intention")
smoke_plt1
```

`r solend()`

<br>

`r qbegin(3)`

Fit your model using `glm()`, and assign it as an object with the name "smoke_mdl1".   

`r qend()`

`r solbegin(show=params$SHOW_SOLS, toggle=params$TOGGLE)`

```{r}
smoke_mdl1 <- glm(Quitting ~ Intention, data = smoke, family = binomial)
summary(smoke_mdl1)
```


`r solend()`

<br>

`r qbegin(4)`

Interpret your coefficients in the context of the study. When doing so, it may be useful to translate the log-odds back into odds.

:::{.callout-tip appearance="simple" collapse="true"}

### Hint

The opposite of the natural logarithm is the exponential (see here for more details if you are interested), and in R these functions are `log()` and `exp()`.

Recall that we can obtain our parameter estimates using various functions such as `summary()`,`coef()`, `coefficients()`, etc. Thus, we want to exponentiate the coefficients from our model in order to translate them back from log-odds.

:::

`r qend()`

`r solbegin(show=params$SHOW_SOLS, toggle=params$TOGGLE)`


```{r}
exp(coefficients(smoke_mdl1))
```

+ $\beta_0$ = `(Intercept)` = `r round(coef(smoke_mdl1)[1],2)`
    - For a participant who reported that they “never intend to quit,” the odds of attempting to quit was 0.14. That is, for those who reportedly “never intend to quit,” the probability that they attempted quitting was 0.14 times the probability that they didn’t.

+ $\beta_1$ = `Intention2` = `r round(coef(smoke_mdl1)[2],2)`
    - Relative to those who "never intend to quit", reporting an "intention to quit but not in the next 6 months" meant that an individuals odds of quitting increased by a factor of 13.2.
    
+ $\beta_2$ = `Intention3` = `r round(coef(smoke_mdl1)[3],2)`
    - Relative to those who "never intend to quit", reporting an "intention to quit in the next 6 months" increased the odds of quitting by a factor of 25.2.

+ $\beta_3$ `Intention4` = `r round(coef(smoke_mdl1)[4],2)`
    - Relative to those who "never intend to quit", reporting an "intention to quit in the next 30 days" was associated with an increase in the odds of attempting to quit by a factor of 28.

`r solend()`

<br>

`r qbegin(7)`

Investigate whether or not:

+ the studentized deviance residuals raise any concerns about outliers
+ there are influential observations

`r qend()`

`r solbegin(show=params$SHOW_SOLS, toggle=params$TOGGLE)`


::: {.panel-tabset}

## Outliers
```{r}
plot(rstudent(smoke_mdl1), ylab = "Studentized Deviance Residuals")

plot(fitted(smoke_mdl1), rstudent(smoke_mdl1),
     xlab = "Fitted values", ylab = "Studentized Deviance Residuals")

arm::binnedplot(fitted(smoke_mdl1), rstudent(smoke_mdl1),
                ylab = "Average Studentized Deviance Residuals")
```

## Influential Observations
```{r}
plot(cooks.distance(smoke_mdl1), ylab = "Cook's Distance")
```

:::

`r solend()`

<br>

`r qbegin(6)`

Perform a Deviance goodness-of-fit test to compare your fitted model to the null. 

$$
\begin{aligned}
M_0 &: \qquad \log \left( \frac{p}{1 - p}\right) = \beta_0 \\
M_1 &: \qquad \log \left( \frac{p}{1 - p}\right) = \beta_0 + \beta_1 Intention2 + \beta_2 Intention3 + \beta_3 Intention4
\end{aligned}
$$

Report which model you think best fits the data.

:::{.callout-tip appearance="simple" collapse="true"}

### Hint 

Consider whether or not your models are nested. The flowchart in [Question 10 of the Semester 2 Week 1 lab](https://uoepsy.github.io/dapr2/2223/labs/2_01_model_comps.html) may be helpful to revisit. 

:::

`r qend()`

`r solbegin(show=params$SHOW_SOLS, toggle=params$TOGGLE)`

First, let's fit the null model:
```{r}
smoke_mdl0 <- glm(Quitting ~ 1, data = smoke, family = "binomial")
summary(smoke_mdl0)
```

Since our models are nested, we can compare using the likelihood ratio test:
```{r}
anova(smoke_mdl0, smoke_mdl1, test = 'Chisq')
```

::: {.callout-important icon=false appearance="minimal"}

At the \5% significance level, the addition of the information about the subjects’ intentions to quit resulted in a significant decrease in model deviance (12). Comparing this with a chi-squared with 3 degrees of freedom results in a $p$=.007.

Hence, we have strong evidence that the model the subjects’ intention to quit are helpful predictors of whether or not they will attempt quitting in the future.

:::

`r solend()`

<br>

`r qbegin(7)`

Check the AIC and BIC values for smoke_mdl0 and smoke_mdl1 - which model should we prefer?

`r qend()`

`r solbegin(show=params$SHOW_SOLS, toggle=params$TOGGLE)`

```{r}
#AIC
AIC(smoke_mdl0, smoke_mdl1)

#BIC
BIC(smoke_mdl0, smoke_mdl1)
```

`r solend()`

<br>

`r qbegin(8)`

Plot the predicted model estimates. 

:::{.callout-tip appearance="simple" collapse="true"}

### Hint

Here you will need to use `plot_model()` from the __sjPlot__ package like you did back in Semester 1. To get your estimates, you will need to specify `type = "est"`. 

:::

`r qend()`

`r solbegin(show=params$SHOW_SOLS, toggle=params$TOGGLE)`

`plot_model()` with `type = "est"` gives a nice way of visualising the model odds ratios and confidence intervals: 

```{r}
#| label: fig-notice-modest
#| fig-cap: Model Estimates
plot_model(smoke_mdl1,
           type = "est")
```

`r solend()`

<br>

`r qbegin(9)`

Provide key model results in a formatted table.

:::{.callout-tip appearance="simple" collapse="true"}

### Hint 

Use `tab_model()` from the __sjPlot__ package. 

Remember that you can rename your DV and IV labels by specifying `dv.labels` and `pred.labels`.

:::

`r qend()`

`r solbegin(show=params$SHOW_SOLS, toggle=params$TOGGLE)`

```{r}
#| label: tbl-smoke-modresults
#| tbl-cap: Regression table for Qotice model
#create table for results
tab_model(smoke_mdl1,
          dv.labels = "Attempt to quit using tobacco products",
          pred.labels = c("Intention2" = "Intend to quit but not in the next 6 months",
                          "Intention3" = "Intend to quit in the next 6 months",
                          "Intention4" = "Intend to quit in the next 30 days"),
          title = "Regression table for Quit Model")
```

`r solend()`

<br>

`r qbegin(10)`

Interpret your results in the context of the research question and report your model in full.

`r qend()`

`r solbegin(show=params$SHOW_SOLS, toggle=params$TOGGLE)`

Make sure to write your results up following [APA guidelines](https://apastyle.apa.org/instructional-aids/numbers-statistics-guide.pdf):

::: {.callout-important icon=false appearance="minimal"}


```{r}
#| include: false
res <- exp(car::Confint(smoke_mdl1))
res <- round(res,2)
```


Whether or not participants made an attempt to quit using tobacco products (binary 0 vs 1; 0 no attempt to quit, 1 attempted to quit) was modeled using logistic regression, with intention to quit ('never intend to quit', 'may intend to quit but not in the next 6 months', 'intend to quit in the next 6 months', 'intend to quit in the next 30 days', with 'never intend to quit' as the reference level) as the only predictor. See @tbl-smoke-modresults for full model results.

Intention to quit was found to be associated with attempt to quit, as indicated by decreased odds of noting the mid-conversation swap ($OR = `r res[2,1]`,\,\, 95\%\, CI\, [`r paste(res[2,2:3],collapse=", ")`]$), after accounting for differences in blood alcohol levels and perceptual load. 

In contrary to what might have been expected, change-blindness appeared to decrease with higher alcohol intoxication, with the odds of noticing the swap increasing `r res[3,1]` times ($[`r paste(res[3,2:3],collapse=", ")`]$) for every 1/100th of a percentage increase in blood alcohol content, holding age and perceptual load constant. 

After accounting for age and blood alcohol levels, the odds of noticing the swap were significantly different depending upon the perceptual load, with higher perceptual load associated with `r res[4,1]` ($[`r paste(res[4,2:3],collapse=", ")`]$) times the odds of noticing the change. 

In summary, older age increased the susceptibility to change blindness. Increased perceptual load was also found to increase the chances of people being blind to change, in keeping with the intuition that we have a finite capacity for attention, which is taken up more by more distracting objects. Surprisingly, levels of alcohol intoxication appeared to be associated with a greater chance of noticing change. 

:::

`r solend()`